<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="../common/jquery-1.8.3.min.js"></script>
    <script src="../common/layui/layui.all.js"></script>
    <link href="../common/layui/css/layui.css" rel="stylesheet">
</head>
<style>
    #chatButton {
        position: fixed;
        right: 0px;
        bottom: 0px;
    }
</style>
<body>
<button id="chatButton" type="button" class="layui-btn">Chat</button>
</body>
<script src="../common/IM.js"></script>
<script src="../common/config.js"></script>
<script src="../common/common.js"></script>
<script>
    $(() => {
        var item = localStorage.getItem("token");
        if (item === null || item === undefined || item.length === 0) {
            layer.confirm('未登录！即将跳转至登录页', {
                btn: ['确定'] //按钮
            }, function () {
                location.href = "./index.html"
            });
        } else {
            checkToken()
        }
        $("#chatButton").click(() => {
            layer.open({
                title: '好友列表',
                type: 2,
                area: ['300px', '450px'],
                fixed: false, //不固定
                maxmin: true,
                offset: 'rb',
                anim: 5,
                isOutAnim: false,
                content: './friends.html'
            });
        })

        function onOpen(e) {
            console.log("aaaaaaaaaaaaa==================>>>>>>>>>>>>>>>>>>>>")
        }

        if (window.WebSocket) {
            if (IM.socket !== null &&
                IM.socket !== undefined &&
                IM.socket.readyState === WebSocket.OPEN) {
                return false
            }
            IM.init(localStorage.getItem("token"), onOpen)
            IM.socket.onmessage = onMessage
            $("#wsPort").val(window.wsConfig.wsPort + "?token=" + localStorage.getItem("token"))

        }


        function onClose(e) {

        }

        function onError(e) {

        }

        function onMessage(e) {
            console.log(JSON.parse(e.data));
            var parse = JSON.parse(e.data);
            var message = ' <div class="panel panel-default">' +
                '  <div class="panel-heading">发送者: ' + parse.sender + '</div>' +
                '        <div class="panel-body">' +
                '            ' + parse.content +
                '        </div>' +
                '    </div>'


            $("#messageList").append($(message))
            $('#messageList').scrollTop($("#messageList")[0].scrollHeight);
        }
    })
</script>
</html>
